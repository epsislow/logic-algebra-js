<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tester</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" />

  <!--link rel="stylesheet" href="/ext/fontawesome.5.0.13.css"/-->

  <!--link rel="stylesheet" href="/ext/bootstrap.4.0.0.css"/-->

  <style>

    .bg-black {
      background-color: #000;
    }
    .button {
      margin-right: 5px;
      padding: 2px;
      color: #fff !important;
    }
    .btn-light {
      color:#000 !important;
    }
    .bg-darkcyan {
      background-color: #005555;
    }
    .bg-util {
      background-color: #552d17;
    }
    .bg-back {
      background-color: mediumslateblue;
    }
    .bg-crafter {
      background-color: #773333;
    }
    .bg-smelter {
      background-color: #444499;
    }
    .bg-power {
      background-color: #224460;
    }
    .bg-silo {
      background-color: #445533;
    }
    .bg-storage {
      background-color: #604460;
    }
    .bg-asmb {
      background-color: #553333;
    }

  </style>
</head>

<body class="bg-black">
<main role="main" class="container">
  Tester
</main><!-- /.container -->

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<!--script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js" integrity="sha384-xBuQ/xzmlsLoJpyjoggmTEz8OWUFM0/RC5BsqQBDX2v5cMvDHcMakNTNrHIW2I5f" crossorigin="anonymous"></script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>

<!--script src="/ext/jQuery.3.2.1.js" type="text/javascript"></script-->

<!--script src="/ext/popper.js" type="text/javascript"></script-->

<!--script src="/ext/bootstrap.4.0.0.js" type="text/javascript"></script-->

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>

<script type="text/javascript" src="/library/Visual.js"></script>

<script type="text/javascript" src="/library/sha1/Random.js"></script>

<script type="module">
  import { NBQueue2 } from '/library/modules/NBQueue.js'

  window.queue = NBQueue2;
  var ra;
     
window.onerror = function (message, url, line, column, error) {
    console.log(message, url, line, column, error);
    alert(message+' L'+line+':'+column);
}

  $('document').ready(function() {

    if('vs' in window) {

      vs.page('Gam2');

      ra = vs.clearBody()
              .section('top')
              .br()
              .addButton('Index', '/index.html')
              .br()
              .container('main','div');

      vs.addSectionsToMain();
      gam2.init();
    }
  });

  window.gam2 = {
    'money': 10000,
    'power': 50,
    'powerUsage':30,
    'res': [],
    'building': [],
    'util': [],
    'menu':[],
    'menuType':0,
    'rd': {
      'getResName': function() {
        var suf = rd.randomBytes(0,1) + rd.pickOneFrom(['um','um','is','ix','us','ad','am'],0);
        return rd.randomName(rd.rand(3,4),0,suf);
      },
    },
    'vs': {
      'opt':{},
      'iddfn': {},
      'dropDown': function(btn, box) {
        //var btn= $(btn);
        //console.log(btn);
        $(btn).after($('<div>').html('test'));
        
        /*
        vs.from('dropdn', btn)
          .br()
          .addText('sdff');*/
      },
      'addOptionsFor': function(idd, opts, fn) {
        this.opt[idd] = opts;
        this.iddfn[idd] = fn;
      },
      'showOptionsFor': function(idd, box, ra) {
        if(!(idd in this.opt)) {
          return;
        }
        for(var i in this.opt[idd]) {
          this.boxOpt(ra, this.opt[idd][i], i, idd, box);
        }
      },
      'clearOptionsFor': function(idd) {
        delete this.opt[idd];
        delete this.iddfn[idd];
      },
      'selectOption': function(idd, opt, box) {
        this.iddfn[idd].apply(gam2, [idd, opt, box]);
      },
      'boxOpt': function(ra, opt, i, idd, box) {
        
        var ra0= ra.container('m-2 p-3 bg-black rounded box-shadow text-light', 'div', 'float:left;width:170px; height: 160px; border: 1px solid #fff; border-style: dashed;')
                .container('border-bottom border-gray pb-2 mb-0', 'h6')
                .addText('Option '+ (parseInt(i)+1))
                .up()
                .container('media text-muted pt-2')
                .container('media-body ml-2 mb-0 small lh-125', 'p')
                .container('d-block text-light', 'strong')
                .addText(opt.text)
                .up()
                .addText(opt.description)
                .br()
                .br();
                
          ra0.addButton('Select',
                (function(i, j, w) { return function() { gam2.vs.selectOption(i, j, w) }; })(idd, opt, box),
                'btn-light button'
            )
      }
    },
    'addRes': function (to,name, amount = 0, unitValue = 0, lvl=0) {
        to.push({
          title: 'Resource',
          name: name,
          description:  'Asteroid resource',
          level: 1,
          amount: amount,
          unitValue: unitValue,
          cost:1500,
          powerUsage:15,
          levelCost: 500,
          color:'dark',
        });
    },
    'addCraft': function (to, name, resMax = 1, ques=1) {
      to.push({
        title: 'Crafter',
        name: name,
        description:  'Craft items',
        resMax: resMax,
        queues: ques,
        recepie: 0,
        amount:0,
        unitValue:0,
        everySec:3,
        cost:5000,
        powerUsage:15,
        level:1,
        levelCost:100,
        color:'crafter',
      });
    },
    'addAsmb': function (to, name, resMax = 2, ques=1) {
      to.push({
        title: 'Assambler',
        name: name,
        description:  'Assamble items',
        resMax: resMax,
        queues: ques,
        cost:10000,
        powerUsage:5,
        level: 1,
        levelCost: 2000,
        color:'asmb',
      });
    },
    'addSmelt': function (to, name, ques=1) {
      to.push({
        title: 'Smelter',
        name: name,
        description:  'Smelt items',
        queues: ques,
        resource:0,
        amount: 0,
        unitValue:0,
        everySec:2,
        cost:2500,
        powerUsage:10,
        level:1,
        levelCost:100,
        color:'smelter',
      });
    },
    'addPower': function (to, name, lvl=1) {
      to.push({
        title: 'Power',
        name: name,
        description: 'Adds power to the grid',
        level: 1,
        generated: 0,
        max:5,
        cost:1500,
        powerUsage:0,
        levelCost: 200,
        color:'power',
      });
    },
    
    'addSilo': function (to, name, slots=1, max=150) {
      to.push({
        title: 'Silo',
        name: name,
        description:  'Silo for resources',
        slots: new Array(slots),
        max: max,
        level: 1,
        cost:650,
        powerUsage:3,
        levelCost: 100,
        color:'silo',
      });
    },
    'addStorage': function (to, name, slots=5, max=20) {
      to.push({
        title: 'Storage',
        name: name,
        description:  'Storage for items',
        slots: new Array(slots),
        max: max,
        level: 1,
        cost: 500,
        powerUsage:5,
        levelCost: 250,
        color:'storage',
      });
    },
    'addMenu': function(name) {
      if(name==='util') {
        this.addPower(this.menu, 'Power 1');
        this.addSmelt(this.menu, 'Smelter 1');
        this.addCraft(this.menu, 'Crafter 1');
        this.addStorage(this.menu, 'Storage 1');
        this.addSilo(this.menu, 'Silo 1')
        this.addAsmb(this.menu, 'Assambler 1');
        
      } else if(name==='res') {
        this.addRes(this.menu, this.rd.getResName(), 0, 7);
        this.addRes(this.menu, this.rd.getResName(), 0, 15);
        
      }
      this.menuType=name;
    },
      'init': function () {
        
        this.addRes(this.res,'Galvinum', 10, 5,2);
        this.addRes(this.res,'Soltzis', 25, 10,2);
        this.show();
        this.initEvents();
      },
      'initEvents': function() {
        setInterval(this.event.everySec, 1000);
      },
      'event': {
        'tim': {},
        'everySec': function() {
          for(let r in gam2.res) {
            var box = gam2.res[r];
            if(box) {
              gam2.actions.mine(r,0);
            }
          }
          for(let u in gam2.util) {
            var box = gam2.util[u];
            if(box && box.everySec) {
              if(!('util'+u in gam2.event.tim)) {
                gam2.event.tim['util'+u]=0;
              }
              gam2.event.tim['util'+u]++;
              if(gam2.event.tim['util'+u] !== box.everySec) {
                continue;
              }
              gam2.event.tim['util'+u]=0;
              
              var maxAmount=0;
              var boxSrc;
              if(box.title=='Smelter') {
                if(!box.resource) {
                  continue;
                }
                //console.log(box.source)
                //continue;
                boxSrc = gam2[box.source[0]][box.source[1]];
                maxAmount = box.level> boxSrc.amount? boxSrc.amount: box.level;
                boxSrc.amount -= maxAmount;
                box.amount+= maxAmount;
              } else if (box.title == 'Crafter') {
                if (!box.resource) {
                  continue;
                }
                boxSrc = gam2[box.source[0]][box.source[1]];
                maxAmount = box.level > boxSrc.amount ? boxSrc.amount: box.level;
                boxSrc.amount -= maxAmount;
                box.amount += maxAmount;
              }
            }
          }
          gam2.actions.show();
        }
      },
      'actions': {
        'show': function() {
            ra.clear();
            gam2.show();
        },
        'mine': function (resId, show=1) {
          //console.log('mine' + resId);
          //setTimeout(function () {
          gam2.res[resId].amount+= gam2.res[resId].level;
          if(show) {
            ra.clear();
            gam2.show();
          }
          //}, 1000);
        },
        'sell': function (resId, amount = -1, show=1) {
          amount = amount<0? gam2.res[resId].amount: amount;
          if(amount> gam2.res[resId].amount) {
            return;
          }
          gam2.res[resId].amount-= amount;
          gam2.money+=gam2.res[resId].unitValue * amount;
          //console.log('sell' + resId + ' ' +  amount);
          if (show) {
            ra.clear();
            gam2.show();
          }
        },
        'search':function () {
          gam2.addMenu('res');
          ra.clear();
          gam2.show();
        },
        'build':function() {
          gam2.addMenu('util');
          ra.clear();
          gam2.show();
        },
        'cancel': function() {
          gam2.menu=[];
          gam2.menuType=0;
          ra.clear();
          gam2.show();
        },
        'selectMenu': function(to, box) {
          to.push(box);
          gam2.money -= box.cost;
          gam2.powerUsage += box.powerUsage;
          //console.log(util)
          gam2.menu= [];
          gam2.menuType=0;
          ra.clear();
          gam2.show();
        },
        'powerOn': function(box) {
          box.generated= box.level*5;
          gam2.power += box.generated;
          ra.clear();
          gam2.show();
        },
        'powerOff': function(box) {
          gam2.power -= box.generated;
          box.generated=0;
          
          ra.clear();
          gam2.show();
        },
        'levelUp': function(box) {
          gam2.money -= box.levelCost;
          box.level++;
          box.levelCost += Math.round(box.levelCost*1.5);
          ra.clear();
          gam2.show();
        },
        'smelterResource': function(idd, box) {
        //console.log(box)
        if(!(idd in gam2.vs.opt)) {
          var options=[];
          for(var i in gam2.res) {
            options.push({
              'text': 'Out: ' + gam2.res[i].name +' bar',
              'description': 'In: ' + gam2.res[i].name,
              'src':'res',
              'id': i,
            });
          }
          gam2.vs.addOptionsFor(idd, options, gam2.actions.smelterResourceSelect);
        } else {
          gam2.vs.clearOptionsFor(idd);
        }
        ra.clear();
        gam2.show();
          
        },
        'smelterResourceSelect': function(idd, opt, box) {
        //console.log('option:'+ i, box);
        var i = opt.id;
        box.resource=gam2.res[i].name;
        box.amount=0;
        box.unitValue=gam2.res[i].unitValue*10;
        box.source = [opt.src, i];
        
        gam2.vs.clearOptionsFor(idd);
        ra.clear();
        gam2.show();
          
        },
        'crafterSell': function(m, box) {
          var amount = box.amount;
          gam2.money += box.unitValue * amount;
          box.amount=0;
          //console.log('sell' + resId + ' ' +  amount);
          if (1) {
            ra.clear();
            gam2.show();
          }
        },
        'crafterRecepie': function(idd, box) {
          //console.log(box)
          if(!(idd in gam2.vs.opt)) {
            var options=[];
            for(var i in gam2.res) {
              options.push({
                'text': 'Out: ' + gam2.res[i].name + ' liquid',
                'description': 'In: ' + gam2.res[i].name +' bar'
              });
            }
            gam2.vs.addOptionsFor(idd, options, gam2.actions.crafterRecepieSelect);
            
          } else {
            gam2.vs.clearOptionsFor(idd);
          }
          ra.clear();
          gam2.show();
        },
        'crafterRecepieSelect': function(idd, i, box) {
          console.log('option:'+ i);
          box.recepie=gam2.res[i].name;
          box.amount=0;
          box.unitValue=gam2.res[i].unitValue*10;
          var o= gam2.vs.opt[idd];
          box.source = o.src;
          
          gam2.vs.clearOptionsFor(idd);
          ra.clear();
          gam2.show();
        }
      },
      'show': function () {
        var box;
        ra.container('m-2 p-3 bg-black rounded box-shadow text-light', 'div', 'float:left;width:170px; height: 160px; border: 1px solid #fff')
                .container('border-bottom border-gray pb-2 mb-0', 'h6')
                .addText('$')
                .up()
                .container('media text-muted pt-2')
                .container('media-body ml-2 mb-0 small lh-125', 'p')
                .container('d-block text-light', 'strong')
                .addText('Money')
                .up()
                .addText('Amount: $' + this.money)
                .br()
                .addText('Power: '+ this.powerUsage +' / '+ this.power)
                .br();

        for(var r in this.res) {
          box = this.res[r];
          var ra2 = ra.container('m-2 p-3 bg-'+box.color+' rounded box-shadow text-light', 'div', 'float:left;width:170px; height: 160px')
                  .container('border-bottom border-gray pb-2 mb-0', 'h6')
                  .addText(box.title+' '+box.level)
                  .up()
                  .container('media text-muted pt-2')
                  .container('media-body ml-2 mb-0 small lh-125', 'p')
                  .container('d-block text-light', 'strong')
                  .addText(box.name)
                  .up()
                  .addText('Amount: ' + box.amount+' $'+  box.unitValue * box.amount)
                  .br()
                  .addText('Level: ' + box.level + ' ($'+box.levelCost+')')
                  .br()
                  .br();


          if (box.title === 'Resource') {
            ra2 //.addButton('Mine', (function(opt) { return function() { gam2.actions.mine(opt) };})(r), 'btn-success button')
                .addButton('Sell 1', (function(opt) { return function() { gam2.actions.sell(opt,1) };})(r), 'btn-warning button')
                .addButton('Sell *', (function(opt) { return function() { gam2.actions.sell(opt) };})(r), 'btn-danger button');
            if(gam2.money > box.levelCost) {
              ra2.addButton('Lvl up',
            (function(box) { return function() { gam2.actions.levelUp(box) };})(box),
            'btn-success button');
            }
          }
        }
        
        if(this.menu.length==0) {
        }
        
        for(var m in this.util) {
        box= this.util[m];
        let ra2= ra.container('m-2 p-3 bg-'+box.color+' rounded box-shadow text-light', 'div', 'float:left;width:170px; height: 160px;')
        .container('border-bottom border-gray pb-2 mb-0', 'h6')
        .addText(box.title+ ' '+box.level)
        .up()
        .container('media text-muted pt-2')
        .container('media-body ml-2 mb-0 small lh-125', 'p')
        .container('d-block text-light', 'strong')
        //.addText(' ')
        //.up()
        
        //.addText(box.description)
        ;
        if(box.title==='Smelter') {
          
          if(box.resource) {
            ra2.addText('Out: '+ box.resource+' bar')
               .up()
               .addText('In: '+box.resource).br()
               .addText('Amount: '+ box.amount+' $'+ box.amount* box.unitValue).br()
               .addText('Level: '+ box.level+ ' (Next: $'+box.levelCost+')')
               ;
          } else {
            ra2.addText('No resource').br().br().br();
          }
          ra2.up().br()
            .addButton('Resource', 
           (function(m, box) { return function(e) { gam2.actions.smelterResource( 'util'+m, box) };})(m,box),
            'btn-warning button');
          if (gam2.money > box.levelCost) {
            ra2.up().addButton('Lvl up',
              (function(box) { return function() { gam2.actions.levelUp(box) }; })(box),
              'btn-success button');
          }
        
        } else if (box.title==='Crafter') {
          if(box.recepie) {
            ra2.addText('Out: '+ box.recepie+' liquid')
               .up()
               .addText('In: '+box.recepie+' bar').br()
               .addText('Amount: '+ box.amount+' $'+ box.amount* box.unitValue).br()
               .addText('Level: '+ box.level+ ' (Next: $'+box.levelCost+')')
               ;
          } else {
            ra2.addText('No recepie').br().br().br();
          }
          ra2.up().br()
            .addButton('Select', 
           (function(m,box) { return function(e) { gam2.actions.crafterRecepie( 'util'+m, box) };})(m, box),
            'btn-warning button');
            
          if (box.recepie) {
            ra2.up().addButton('Sell *', 
            (function(m, box) { return function() {gam2.actions.crafterSell(m, box)};})(m, box),
            'btn-danger button')
          }
        
          if (gam2.money > box.levelCost) {
            ra2.up().addButton('Lvl up',
              (function(box) { return function() { gam2.actions.levelUp(box) }; })(box),
              'btn-success button');
          }
        } else if (box.title==='Storage') {
          ra2.up().br().br().br().br()
            .addButton('Lvl up', false, 'btn-success button')
            .addButton('Sell *', false, 'btn-warning button');
            
        } else if (box.title==='Silo') {
          ra2.up().br().br().br().br()
            .addButton('Lvl up', false, 'btn-success button')
            .addButton('Sell *', false, 'btn-warning button');
          
        } else if (box.title=='Power') {
          var ra3= ra2.up().br()
            .addText('Level: '+ box.level+ ' (Next: $'+box.levelCost+')')
            .br()
            .addText('Generated: ' + box.generated +' / '+ box.level * 5)
            .br().br();
          if(box.generated === 0) {
            ra3
            .addButton('On', 
            (function(box) { return function() { gam2.actions.powerOn(box) };})(box),
             'btn-success button');
             if(gam2.money > box.levelCost) {
              ra3.addButton('Lvl up',
              (function(box) { return function() { gam2.actions.levelUp(box) };})(box),
             'btn-success button');
             }
          } else {
             ra3
            .addButton('Off', 
            (function(box) { return function() { gam2.actions.powerOff(box) };})(box),
             'btn-success button');

          }
        }
         this.vs.showOptionsFor('util'+m, box, ra);
        }
        if(this.menu.length==0) {
                ra.container('m-2 p-3 bg-darkcyan rounded box-shadow text-light', 'div', 'float:left;width:170px; height: 160px; border-style: dashed')
                .container('border-bottom border-gray pb-2 mb-0', 'h6')
                .addText('+1 Resource')
                .up()
                .container('media text-muted pt-2')
                .container('media-body ml-2 mb-0 small lh-125', 'p')
                .container('d-block text-light', 'strong')
                .addText('Up for more?')
                .up()
                .br()
                .br()
                .br()
                .addButton('Search', gam2.actions.search, 'btn-light button')
                ;

          ra.container('m-2 p-3 bg-util rounded box-shadow text-light', 'div', 'float:left;width:170px; height: 160px; border-style: dashed')
          .container('border-bottom border-gray pb-2 mb-0', 'h6')
          .addText('+1 Utility')
          .up()
          .container('media text-muted pt-2')
          .container('media-body ml-2 mb-0 small lh-125', 'p')
          .container('d-block text-light', 'strong')
          .addText('Need an utility?')
          .up()
          .br()
          .br()
          .br()
          .addButton('Build', gam2.actions.build, 'btn-light button')
          ;
        } else {
          var powerLeft = gam2.power - gam2.powerUsage;
          for(var m in this.menu) {
            box= this.menu[m];
            var ra0= ra.container('m-2 p-3 bg-black rounded box-shadow text-light', 'div', 'float:left;width:170px; height: 160px; border-style: dashed')
            .container('border-bottom border-gray pb-2 mb-0', 'h6')
            .addText(box.title)
            .up()
            .container('media text-muted pt-2')
            .container('media-body ml-2 mb-0 small lh-125', 'p')
            .container('d-block text-light', 'strong')
            .addText(box.name)
            .up()
            .addText(box.description)
            .br()
            .addText('Cost: '+box.cost)
            .br()
            .addText('Power Usage: '+box.powerUsage)
            .br();
            if(gam2.money < box.cost) {
              ra0
                .container('d-block text-danger')
                .addText('Low money');
            } else if (powerLeft < box.powerUsage ) {  
              
              ra0
                .container('d-block text-danger')
                .addText('Low power');
            } else {
              ra0.addButton('Select',
              (function(to,w) { return function() { gam2.actions.selectMenu(to,w) };})(gam2[gam2.menuType], box),
              'btn-light button'
            )
            ;
            }
          }
          ra.container('m-2 p-3 bg-back rounded box-shadow text-light', 'div', 'float:left;width:170px; height: 160px; border-style: dashed')
          .container('border-bottom border-gray pb-2 mb-0', 'h6')
          .addText('Back')
          .up()
          .container('media text-muted pt-2')
          .container('media-body ml-2 mb-0 small lh-125', 'p')
          .container('d-block text-light', 'strong')
          .addText('Go to previous grid')
          .up()
          .br()
          .br()
          .br()
          .addButton('Cancel', gam2.actions.cancel, 'btn-light button')
          ;
        }
      }
  };
</script>
</body>
</html>